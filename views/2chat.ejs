<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>LawGPT - AI Legal Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    /* Professional, Clean Design */
    :root { 
      --bg-color: #f4f6f8;
      --chat-bg: #ffffff;
      --primary: #2563eb; 
      --primary-dark: #1d4ed8;
      --text: #1f2937;
      --msg-user: #e0f2fe;
      --msg-bot: #f3f4f6;
      --border: #e5e7eb;
    }
    body { 
      margin: 0; 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      background: var(--bg-color); 
      color: var(--text);
      display: grid; 
      grid-template-rows: auto 1fr auto; 
      height: 100vh; 
    }

    /* Header */
    header { 
      background: #ffffff; 
      border-bottom: 1px solid var(--border);
      padding: 1rem; 
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    h1 { margin: 0; font-size: 1.25rem; font-weight: 600; color: #111; }

    /* Chat Area */
    main { 
      overflow-y: auto; 
      padding: 1rem; 
      display: flex; 
      flex-direction: column; 
      gap: 1rem;
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }

    .message {
      max-width: 85%;
      padding: 1rem;
      border-radius: 0.75rem;
      line-height: 1.6;
      position: relative;
    }
    
    .message.user { 
      align-self: flex-end; 
      background: var(--msg-user); 
      color: #0c4a6e;
      border-bottom-right-radius: 0.1rem;
    }
    
    .message.bot { 
      align-self: flex-start; 
      background: var(--msg-bot); 
      border-bottom-left-radius: 0.1rem;
    }

    /* Smart Sources Styling */
    .sources-list {
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid #e5e5e5;
      font-size: 0.9rem;
    }
    .sources-title { font-weight: 600; color: #555; margin-bottom: 0.25rem; display: block; }
    .source-item { 
      display: block; 
      color: #4b5563; 
      text-decoration: none; 
      margin-bottom: 0.25rem;
    }
    .badge {
      display: inline-block;
      background: #e5e7eb;
      color: #374151;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
      margin-right: 6px;
    }

    /* Input Area */
    form { 
      background: #fff; 
      padding: 1rem; 
      border-top: 1px solid var(--border); 
      display: grid; 
      grid-template-columns: 1fr auto; 
      gap: 0.75rem; 
      max-width: 800px;
      margin: 0 auto;
      width: 100%;
      box-sizing: border-box;
    }
    
    .input-wrapper {
      display: flex;
      flex-direction: column;
    }

    textarea {
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-family: inherit;
      resize: none;
      height: 50px;
    }
    textarea:focus { outline: 2px solid var(--primary); border-color: transparent; }

    /* Helpful Hint Text */
    .hint-text {
      font-size: 0.85rem;
      color: #666;
      margin-top: 6px;
    }

    button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      font-size: 1rem;
      height: 50px; /* Align with textarea */
    }
    button:hover { background: var(--primary-dark); }

    /* Accessibility Utilities */
    .sr-only { position:absolute; width:1px; height:1px; overflow:hidden; clip:rect(0,0,0,0); }
    
    /* Copy Button */
    .copy-btn {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: transparent;
      border: 1px solid #ccc;
      color: #555;
      font-size: 0.8rem;
      padding: 2px 6px;
      cursor: pointer;
      border-radius: 4px;
    }
    .copy-btn:hover { background: #fff; border-color: #999; }

  </style>
</head>
<body>

  <header>
    <h1>LawGPT India</h1>
  </header>

  <div id="live-region" class="sr-only" aria-live="polite"></div>

  <main id="chat-container">
    <div class="message bot">
      <strong>Namaste! I am LawGPT.</strong><br><br>
      I use the new <strong>BNS 2023</strong> laws by default.<br>
      <ul>
        <li>For new laws, just ask: <em>"What is Section 302?"</em></li>
        <li>For old laws, type <strong>IPC</strong>: <em>"What is IPC 302?"</em></li>
      </ul>
    </div>
  </main>

  <form id="chat-form">
    <div class="input-wrapper">
      <label for="user-input" class="sr-only">Type your legal question. Type IPC for old laws.</label>
      <textarea id="user-input" placeholder="Type here... (e.g., 'IPC 302' or 'Section 103')" required></textarea>
      <span class="hint-text" aria-hidden="true">
        Tip: Type <strong>"IPC"</strong> for old laws (e.g., IPC 420). Default is New Law.
      </span>
    </div>
    <button type="submit">Send</button>
  </form>

  <script>
    const form = document.getElementById('chat-form');
    const input = document.getElementById('user-input');
    const chatContainer = document.getElementById('chat-container');
    const liveRegion = document.getElementById('live-region');

    function speak(text) {
      liveRegion.textContent = text;
    }

    function createCopyButton(text) {
      const btn = document.createElement('button');
      btn.className = 'copy-btn';
      btn.innerText = 'Copy';
      btn.setAttribute('aria-label', 'Copy answer to clipboard');
      btn.onclick = () => {
        navigator.clipboard.writeText(text);
        btn.innerText = 'Copied!';
        speak('Answer copied to clipboard');
        setTimeout(() => btn.innerText = 'Copy', 2000);
      };
      return btn;
    }

    function appendMessage(text, sender, sources = []) {
      const div = document.createElement('div');
      div.className = `message ${sender}`;
      
      // Main Text (Handle newlines)
      const content = document.createElement('div');
      content.innerHTML = text.replace(/\n/g, '<br>');
      div.appendChild(content);

      // Add Copy Button for Bot
      if (sender === 'bot') {
        div.appendChild(createCopyButton(text));
      }

      // Add Sources if they exist
      if (sender === 'bot' && sources.length > 0) {
        const sourceBox = document.createElement('div');
        sourceBox.className = 'sources-list';
        
        const title = document.createElement('span');
        title.className = 'sources-title';
        title.innerText = 'References used:';
        sourceBox.appendChild(title);

        sources.forEach(src => {
          const item = document.createElement('div');
          item.className = 'source-item';
          
          let label = "";
          // Smart Labeling
          if (src.article) label += `<span class="badge">Article ${src.article}</span>`;
          if (src.section) label += `<span class="badge">Section ${src.section}</span>`;
          if (src.page)    label += ` (Page ${src.page})`;
          
          // Fallback if no specific metadata
          if (!label) label = src.source.replace(/_/g, ' ').replace('.txt', '');

          item.innerHTML = label;
          sourceBox.appendChild(item);
        });
        div.appendChild(sourceBox);
      }

      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const question = input.value.trim();
      if (!question) return;

      // 1. Show User Message
      appendMessage(question, 'user');
      input.value = '';
      speak("Sending question...");

      try {
        // 2. Call API
        const res = await fetch('/api/ask', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: question })
        });

        const data = await res.json();

        // 3. Show Bot Response
        if (data.error) {
          appendMessage(`Error: ${data.error}`, 'bot');
          speak(`Error: ${data.error}`);
        } else {
          appendMessage(data.reply, 'bot', data.sources);
          speak(`Answer received: ${data.reply}`);
        }

      } catch (err) {
        appendMessage("Network error. Please check your connection.", 'bot');
      }
    });
  </script>
</body>
</html>